// src/pages/VulnerabilityScanner.js
import React, { useState, useCallback, useMemo } from "react";
import apiClient, { API_ENDPOINTS } from "../config/api";
import { useNavigate } from "react-router-dom";
import SeverityBadge from "../components/SeverityBadge";
import {
  ShieldAlert,
  Package,
  ScanSearch,
  AlertOctagon,
  Shield,
  Wrench,
  Loader,
  AlertCircle,
  CheckCircle2,
  Activity,
  AlertTriangle,
  CheckCircle,
} from "lucide-react";

export default function VulnerabilityScanner() {
  const [name, setName] = useState("");
  const [ecosystem, setEcosystem] = useState("PyPI");
  const [version, setVersion] = useState("");
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  const navigate = useNavigate();

  const handleSearch = useCallback(
    async (e) => {
      e.preventDefault();

      const trimmedName = name.trim();
      const trimmedEcosystem = ecosystem.trim();
      const trimmedVersion = version.trim();

      if (!trimmedName) {
        setError("Package name is required.");
        return;
      }

      setLoading(true);
      setError("");
      setResults([]);

      try {
        const res = await apiClient.post(API_ENDPOINTS.scans.vulnerability, {
          name: trimmedName,
          ecosystem: trimmedEcosystem,
          version: trimmedVersion || undefined,
        });

        const vulns = res.data?.results || [];
        if (vulns.length === 0) {
          setError("No vulnerabilities found for the given package.");
        } else {
          setResults(vulns);
        }
      } catch (err) {
        console.error(err);
        setError("Failed to fetch vulnerabilities from server.");
      } finally {
        setLoading(false);
      }
    },
    [name, ecosystem, version]
  );

  const handleRemediate = async () => {
    if (results.length === 0) return;

    const mappedVulns = results.map((vuln) => ({
      id: vuln.id || "N/A",
      package: vuln.package || vuln.id || "unknown-package",
      ecosystem: vuln.ecosystem || ecosystem || "PyPI",
      severity:
        vuln.severity !== undefined && vuln.severity !== null
          ? parseFloat(vuln.severity)
          : 0.0,
    }));

    try {
      const response = await apiClient.post(
        API_ENDPOINTS.remediation,
        mappedVulns
      );

      navigate("/remediation", {
        state: { vulns: response.data },
      });
    } catch (err) {
      console.error("Failed to generate remediation plan:", err);
      alert("Failed to generate remediation plan.");
    }
  };

  // Calculate summary statistics
  const summary = useMemo(() => {
    const counts = {
      critical: 0,
      high: 0,
      medium: 0,
      low: 0,
      unknown: 0,
      total: results.length,
    };

    results.forEach((vuln) => {
      const severity = vuln.severity;
      if (severity >= 9.0) counts.critical++;
      else if (severity >= 7.0) counts.high++;
      else if (severity >= 4.0) counts.medium++;
      else if (severity > 0) counts.low++;
      else counts.unknown++;
    });

    return counts;
  }, [results]);

  return (
    <div style={{ maxWidth: "1200px", margin: "0 auto" }}>
      {/* Header */}
      <div style={{ marginBottom: "var(--spacing-6)" }}>
        <div
          style={{
            display: "flex",
            alignItems: "center",
            gap: "var(--spacing-3)",
            marginBottom: "var(--spacing-3)",
          }}
        >
          <div
            style={{
              width: "56px",
              height: "56px",
              borderRadius: "var(--radius-lg)",
              background: "linear-gradient(135deg, #DC2626 0%, #991B1B 100%)",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              boxShadow: "0 8px 16px rgba(220, 38, 38, 0.25)",
              flexShrink: 0,
            }}
          >
            <ShieldAlert size={28} color="white" strokeWidth={2} />
          </div>
          <div>
            <h1
              style={{
                fontSize: "var(--font-size-2xl)",
                fontWeight: "var(--font-weight-bold)",
                marginBottom: "var(--spacing-1)",
              }}
            >
              Vulnerability Scanner
            </h1>
            <p
              style={{
                color: "var(--color-text-secondary)",
                fontSize: "var(--font-size-sm)",
              }}
            >
              Scan software packages for known security vulnerabilities
            </p>
          </div>
        </div>
      </div>

      {/* Scan Form */}
      <div className="card" style={{ marginBottom: "var(--spacing-6)" }}>
        <form onSubmit={handleSearch}>
          <div
            style={{
              display: "grid",
              gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))",
              gap: "var(--spacing-4)",
              marginBottom: "var(--spacing-4)",
            }}
          >
            <div>
              <label className="input-label">
                <Package
                  size={16}
                  style={{ marginRight: "var(--spacing-2)" }}
                />
                Package Name
              </label>
              <input
                type="text"
                className="input"
                placeholder="e.g., flask, openssl"
                value={name}
                onChange={(e) => setName(e.target.value)}
                required
                disabled={loading}
              />
            </div>

            <div>
              <label className="input-label">
                <Shield size={16} style={{ marginRight: "var(--spacing-2)" }} />
                Ecosystem
              </label>
              <select
                className="input"
                value={ecosystem}
                onChange={(e) => setEcosystem(e.target.value)}
                disabled={loading}
              >
                <option value="PyPI">PyPI</option>
                <option value="npm">npm</option>
                <option value="Go">Go</option>
                <option value="Maven">Maven</option>
                <option value="RubyGems">RubyGems</option>
                <option value="crates.io">Rust (crates.io)</option>
              </select>
            </div>

            <div>
              <label className="input-label">Version (Optional)</label>
              <input
                type="text"
                className="input"
                placeholder="e.g., 2.0.1"
                value={version}
                onChange={(e) => setVersion(e.target.value)}
                disabled={loading}
              />
            </div>
          </div>

          <button
            className="btn btn-primary"
            type="submit"
            disabled={loading}
            style={{
              width: "100%",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              gap: "var(--spacing-2)",
            }}
          >
            {loading ? (
              <>
                <Loader size={18} className="spinner" strokeWidth={2} />
                <span>Scanning...</span>
              </>
            ) : (
              <>
                <ScanSearch size={18} strokeWidth={2} />
                <span>Scan for Vulnerabilities</span>
              </>
            )}
          </button>
        </form>
      </div>

      {/* Loading State */}
      {loading && (
        <div
          className="card"
          style={{ textAlign: "center", padding: "var(--spacing-8)" }}
        >
          <Loader
            size={48}
            className="spinner"
            style={{
              margin: "0 auto var(--spacing-4)",
              color: "#DC2626",
            }}
          />
          <h3
            style={{
              fontSize: "var(--font-size-lg)",
              fontWeight: "var(--font-weight-semibold)",
              marginBottom: "var(--spacing-2)",
            }}
          >
            Scanning Package...
          </h3>
          <p style={{ color: "var(--color-text-secondary)" }}>
            Checking for known vulnerabilities in {ecosystem} package: {name}
          </p>
        </div>
      )}

      {/* Summary Cards */}
      {results.length > 0 && (
        <div
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))",
            gap: "var(--spacing-4)",
            marginBottom: "var(--spacing-6)",
          }}
        >
          <div
            className="card"
            style={{
              background: "linear-gradient(135deg, #DC2626 0%, #991B1B 100%)",
              color: "white",
              border: "none",
            }}
          >
            <div
              style={{
                display: "flex",
                alignItems: "center",
                gap: "var(--spacing-2)",
                marginBottom: "var(--spacing-3)",
              }}
            >
              <AlertCircle size={20} />
              <h3
                style={{
                  fontSize: "var(--font-size-base)",
                  fontWeight: "var(--font-weight-semibold)",
                }}
              >
                Critical
              </h3>
            </div>
            <p
              style={{
                fontSize: "2.5rem",
                fontWeight: "var(--font-weight-bold)",
                marginBottom: "var(--spacing-1)",
              }}
            >
              {summary.critical}
            </p>
            <p style={{ fontSize: "var(--font-size-sm)", opacity: 0.9 }}>
              Severity â‰¥ 9.0
            </p>
          </div>

          <div
            className="card"
            style={{
              background: "linear-gradient(135deg, #F97316 0%, #EA580C 100%)",
              color: "white",
              border: "none",
            }}
          >
            <div
              style={{
                display: "flex",
                alignItems: "center",
                gap: "var(--spacing-2)",
                marginBottom: "var(--spacing-3)",
              }}
            >
              <AlertTriangle size={20} />
              <h3
                style={{
                  fontSize: "var(--font-size-base)",
                  fontWeight: "var(--font-weight-semibold)",
                }}
              >
                High
              </h3>
            </div>
            <p
              style={{
                fontSize: "2.5rem",
                fontWeight: "var(--font-weight-bold)",
                marginBottom: "var(--spacing-1)",
              }}
            >
              {summary.high}
            </p>
            <p style={{ fontSize: "var(--font-size-sm)", opacity: 0.9 }}>
              7.0 - 8.9
            </p>
          </div>

          <div
            className="card"
            style={{
              background: "linear-gradient(135deg, #F59E0B 0%, #D97706 100%)",
              color: "white",
              border: "none",
            }}
          >
            <div
              style={{
                display: "flex",
                alignItems: "center",
                gap: "var(--spacing-2)",
                marginBottom: "var(--spacing-3)",
              }}
            >
              <Bug size={20} />
              <h3
                style={{
                  fontSize: "var(--font-size-base)",
                  fontWeight: "var(--font-weight-semibold)",
                }}
              >
                Medium
              </h3>
            </div>
            <p
              style={{
                fontSize: "2.5rem",
                fontWeight: "var(--font-weight-bold)",
                marginBottom: "var(--spacing-1)",
              }}
            >
              {summary.medium}
            </p>
            <p style={{ fontSize: "var(--font-size-sm)", opacity: 0.9 }}>
              4.0 - 6.9
            </p>
          </div>

          <div
            className="card"
            style={{
              background: "linear-gradient(135deg, #10B981 0%, #059669 100%)",
              color: "white",
              border: "none",
            }}
          >
            <div
              style={{
                display: "flex",
                alignItems: "center",
                gap: "var(--spacing-2)",
                marginBottom: "var(--spacing-3)",
              }}
            >
              <CheckCircle size={20} />
              <h3
                style={{
                  fontSize: "var(--font-size-base)",
                  fontWeight: "var(--font-weight-semibold)",
                }}
              >
                Low
              </h3>
            </div>
            <p
              style={{
                fontSize: "2.5rem",
                fontWeight: "var(--font-weight-bold)",
                marginBottom: "var(--spacing-1)",
              }}
            >
              {summary.low}
            </p>
            <p style={{ fontSize: "var(--font-size-sm)", opacity: 0.9 }}>
              0.1 - 3.9
            </p>
          </div>

          <div
            className="card"
            style={{
              background: "linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)",
              color: "white",
              border: "none",
            }}
          >
            <div
              style={{
                display: "flex",
                alignItems: "center",
                gap: "var(--spacing-2)",
                marginBottom: "var(--spacing-3)",
              }}
            >
              <Package size={20} />
              <h3
                style={{
                  fontSize: "var(--font-size-base)",
                  fontWeight: "var(--font-weight-semibold)",
                }}
              >
                Total
              </h3>
            </div>
            <p
              style={{
                fontSize: "2.5rem",
                fontWeight: "var(--font-weight-bold)",
                marginBottom: "var(--spacing-1)",
              }}
            >
              {summary.total}
            </p>
            <p style={{ fontSize: "var(--font-size-sm)", opacity: 0.9 }}>
              Vulnerabilities
            </p>
          </div>
        </div>
      )}

      {/* Remediation Button */}
      {results.length > 0 && (
        <div
          style={{
            display: "flex",
            justifyContent: "flex-end",
            marginBottom: "var(--spacing-4)",
          }}
        >
          <button onClick={handleRemediate} className="btn btn-secondary">
            <Wrench size={18} />
            Generate Remediation Plan
          </button>
        </div>
      )}

      {/* Error State */}
      {error && !loading && (
        <div
          style={{
            padding: "var(--spacing-4)",
            borderRadius: "var(--radius-lg)",
            backgroundColor: results.length === 0 ? "#D1FAE5" : "#FEF3C7",
            border: `1px solid ${results.length === 0 ? "#6EE7B7" : "#FDE047"}`,
            display: "flex",
            alignItems: "flex-start",
            gap: "var(--spacing-3)",
            marginBottom: "var(--spacing-6)",
          }}
        >
          {results.length === 0 ? (
            <>
              <CheckCircle
                size={24}
                color="#059669"
                style={{ flexShrink: 0, marginTop: "2px" }}
              />
              <div>
                <h3
                  style={{
                    color: "#059669",
                    fontWeight: "var(--font-weight-semibold)",
                    marginBottom: "var(--spacing-1)",
                  }}
                >
                  No Vulnerabilities Found
                </h3>
                <p style={{ color: "#047857" }}>{error}</p>
              </div>
            </>
          ) : (
            <>
              <AlertTriangle
                size={24}
                color="#D97706"
                style={{ flexShrink: 0, marginTop: "2px" }}
              />
              <div>
                <h3
                  style={{
                    color: "#D97706",
                    fontWeight: "var(--font-weight-semibold)",
                    marginBottom: "var(--spacing-1)",
                  }}
                >
                  Notice
                </h3>
                <p style={{ color: "#92400E" }}>{error}</p>
              </div>
            </>
          )}
        </div>
      )}

      {/* Results List */}
      {results.length > 0 ? (
        <div style={{ display: "grid", gap: "var(--spacing-4)" }}>
          {results.map((vuln, index) => (
            <div key={index} className="card">
              <div
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "flex-start",
                  marginBottom: "var(--spacing-3)",
                }}
              >
                <div>
                  <h3
                    style={{
                      fontSize: "var(--font-size-lg)",
                      fontWeight: "var(--font-weight-semibold)",
                      marginBottom: "var(--spacing-1)",
                    }}
                  >
                    {vuln.id || "N/A"}
                  </h3>
                  <p
                    style={{
                      fontSize: "var(--font-size-sm)",
                      color: "var(--color-text-secondary)",
                    }}
                  >
                    {vuln.package || "N/A"}
                  </p>
                </div>
                <SeverityBadge severity={vuln.severity} />
              </div>

              <div
                style={{
                  display: "grid",
                  gridTemplateColumns: "repeat(auto-fit, minmax(250px, 1fr))",
                  gap: "var(--spacing-3)",
                  marginBottom: "var(--spacing-3)",
                  padding: "var(--spacing-3)",
                  backgroundColor: "var(--color-bg-secondary)",
                  borderRadius: "var(--radius-md)",
                }}
              >
                <div>
                  <p
                    style={{
                      fontSize: "var(--font-size-sm)",
                      marginBottom: "var(--spacing-1)",
                    }}
                  >
                    <strong style={{ color: "var(--color-text-secondary)" }}>
                      Source:
                    </strong>{" "}
                    <span style={{ color: "var(--color-text-primary)" }}>
                      {vuln.source || "N/A"}
                    </span>
                  </p>
                  <p style={{ fontSize: "var(--font-size-sm)" }}>
                    <strong style={{ color: "var(--color-text-secondary)" }}>
                      Ecosystem:
                    </strong>{" "}
                    <span style={{ color: "var(--color-text-primary)" }}>
                      {vuln.ecosystem || "N/A"}
                    </span>
                  </p>
                </div>
                <div>
                  <p style={{ fontSize: "var(--font-size-sm)" }}>
                    <strong style={{ color: "var(--color-text-secondary)" }}>
                      Affected Versions:
                    </strong>{" "}
                    <span style={{ color: "var(--color-text-primary)" }}>
                      {vuln.affected || "Unknown"}
                    </span>
                  </p>
                </div>
              </div>

              <div
                style={{
                  paddingTop: "var(--spacing-3)",
                  borderTop: "1px solid var(--color-border)",
                }}
              >
                <p
                  style={{
                    fontSize: "var(--font-size-sm)",
                    color: "var(--color-text-primary)",
                    lineHeight: "1.6",
                  }}
                >
                  {vuln.summary || "No description available."}
                </p>
              </div>
            </div>
          ))}
        </div>
      ) : (
        !loading &&
        !error && (
          <div
            className="card"
            style={{ textAlign: "center", padding: "var(--spacing-12)" }}
          >
            <Package
              size={64}
              style={{
                margin: "0 auto var(--spacing-4)",
                color: "var(--color-text-tertiary)",
                opacity: 0.5,
              }}
            />
            <p
              style={{
                color: "var(--color-text-secondary)",
                fontSize: "var(--font-size-base)",
              }}
            >
              Scan results will appear here
            </p>
          </div>
        )
      )}
    </div>
  );
}
