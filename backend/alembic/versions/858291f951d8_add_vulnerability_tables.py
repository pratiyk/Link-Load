"""Add vulnerability tables (legacy placeholder).

Revision ID: 858291f951d8
Revises: cd3650f92a1d
Create Date: 2025-10-21 18:22:16.450823

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '858291f951d8'
down_revision: Union[str, None] = 'cd3650f92a1d'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def _table_exists(inspector, table_name: str) -> bool:
    return table_name in inspector.get_table_names()


def _index_exists(inspector, table_name: str, index_name: str) -> bool:
    if not _table_exists(inspector, table_name):
        return False
    return any(idx['name'] == index_name for idx in inspector.get_indexes(table_name))


def upgrade() -> None:
    """Ensure discovery/risk tables exist without creating duplicates."""
    conn = op.get_bind()
    inspector = sa.inspect(conn)

    if not _table_exists(inspector, 'discovered_assets'):
        op.create_table(
            'discovered_assets',
            sa.Column('id', sa.Integer(), primary_key=True),
            sa.Column('asset_type', sa.String(), nullable=False),
            sa.Column('identifier', sa.String(), nullable=False),
            sa.Column('asset_metadata', sa.JSON(), nullable=True),
            sa.Column('first_seen', sa.DateTime(), nullable=True),
            sa.Column('last_seen', sa.DateTime(), nullable=True),
            sa.Column('risk_score', sa.Float(), nullable=True)
        )
        op.create_index('ix_discovered_assets_id', 'discovered_assets', ['id'])

    if not _table_exists(inspector, 'vulnerabilities'):
        op.create_table(
            'vulnerabilities',
            sa.Column('id', sa.Integer(), primary_key=True),
            sa.Column('source', sa.String(), nullable=False),
            sa.Column('title', sa.String(), nullable=False),
            sa.Column('description', sa.Text(), nullable=True),
            sa.Column('severity', sa.Float(), nullable=False),
            sa.Column('cvss_score', sa.Float(), nullable=True),
            sa.Column('cvss_vector', sa.String(), nullable=True),
            sa.Column('cve_ids', sa.JSON(), nullable=True),
            sa.Column('references', sa.JSON(), nullable=True),
            sa.Column('status', sa.String(), nullable=False, server_default='open'),
            sa.Column('raw_data', sa.JSON(), nullable=True),
            sa.Column('tags', sa.JSON(), nullable=True),
            sa.Column('exploit_available', sa.Boolean(), nullable=False, server_default='false'),
            sa.Column('exploit_details', sa.JSON(), nullable=True),
            sa.Column('business_impact', sa.String(), nullable=True),
            sa.Column('attack_vector', sa.String(), nullable=True),
            sa.Column('likelihood', sa.Float(), nullable=True),
            sa.Column('impact_score', sa.Float(), nullable=True),
            sa.Column('risk_score', sa.Float(), nullable=True),
            sa.Column('created_by', sa.String(), nullable=True),
            sa.Column('updated_by', sa.String(), nullable=True),
            sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()')),
            sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()')),
            sa.Column('first_seen', sa.DateTime(timezone=True), server_default=sa.text('now()')),
            sa.Column('last_seen', sa.DateTime(timezone=True), server_default=sa.text('now()')),
            sa.Column('remediation_deadline', sa.DateTime(timezone=True), nullable=True),
            sa.Column('asset_id', sa.Integer(), sa.ForeignKey('discovered_assets.id'), nullable=True)
        )
        op.create_index('ix_vulnerabilities_status', 'vulnerabilities', ['status'])

    if not _table_exists(inspector, 'threat_intel_data'):
        op.create_table(
            'threat_intel_data',
            sa.Column('id', sa.Integer(), primary_key=True)
        )
        op.create_index('ix_threat_intel_data_id', 'threat_intel_data', ['id'])

    if not _table_exists(inspector, 'vulnerability_mitigations'):
        op.create_table(
            'vulnerability_mitigations',
            sa.Column('id', sa.Integer(), primary_key=True)
        )
        op.create_index('ix_vulnerability_mitigations_id', 'vulnerability_mitigations', ['id'])


def downgrade() -> None:
    """Drop objects only if they were created here."""
    conn = op.get_bind()
    inspector = sa.inspect(conn)

    if _index_exists(inspector, 'vulnerability_mitigations', 'ix_vulnerability_mitigations_id'):
        op.drop_index('ix_vulnerability_mitigations_id', table_name='vulnerability_mitigations')
    if _table_exists(inspector, 'vulnerability_mitigations'):
        op.drop_table('vulnerability_mitigations')

    if _index_exists(inspector, 'threat_intel_data', 'ix_threat_intel_data_id'):
        op.drop_index('ix_threat_intel_data_id', table_name='threat_intel_data')
    if _table_exists(inspector, 'threat_intel_data'):
        op.drop_table('threat_intel_data')

    if _index_exists(inspector, 'vulnerabilities', 'ix_vulnerabilities_status'):
        op.drop_index('ix_vulnerabilities_status', table_name='vulnerabilities')
    if _table_exists(inspector, 'vulnerabilities'):
        op.drop_table('vulnerabilities')

    if _index_exists(inspector, 'discovered_assets', 'ix_discovered_assets_id'):
        op.drop_index('ix_discovered_assets_id', table_name='discovered_assets')
    if _table_exists(inspector, 'discovered_assets'):
        op.drop_table('discovered_assets')