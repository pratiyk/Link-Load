"""
Models for vulnerability management and security scanning.
"""

from sqlalchemy import (
    Column, Integer, String, DateTime, JSON, ForeignKey, 
    Float, Boolean, Table, Enum
)
from sqlalchemy.orm import relationship
from datetime import datetime
import enum
from typing import List, Optional
from pydantic import BaseModel, Field

from app.database import Base
from app.models.asset_models import DiscoveredAsset
from app.models.threat_intel_models import MITRETechnique
from app.models.associations import vulnerability_technique_association

class ScannerType(str, enum.Enum):
    """Types of supported security scanners"""
    ZAP = "zap"
    NUCLEI = "nuclei"
    WAPITI = "wapiti"
    CUSTOM = "custom"

class ScanStatus(str, enum.Enum):
    """Status of a security scan"""
    PENDING = "pending"
    RUNNING = "running"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELLED = "cancelled"
    TIMEOUT = "timeout"

class SeverityLevel(str, enum.Enum):
    """Standardized severity levels"""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"

class VulnerabilityStatus(str, enum.Enum):
    """Status of a vulnerability"""
    OPEN = "open"
    IN_PROGRESS = "in_progress"
    FIXED = "fixed"
    FALSE_POSITIVE = "false_positive"
    RISK_ACCEPTED = "risk_accepted"

class SecurityScan(Base):
    """Record of a security scan"""
    __tablename__ = "security_scans"

    id = Column(String, primary_key=True)
    user_id = Column(String, nullable=False)
    target_url = Column(String, nullable=False)
    scan_types = Column(JSON)  # List of ScannerType
    status = Column(String, default=ScanStatus.PENDING)
    started_at = Column(DateTime, default=datetime.utcnow)
    completed_at = Column(DateTime)
    duration = Column(Integer)  # Duration in seconds
    
    # Scan configuration and results
    scan_config = Column(JSON)  # Scanner-specific configuration
    progress = Column(JSON)  # ScanProgress data
    summary = Column(JSON)  # ScanSummary data
    errors = Column(JSON)  # List of error messages
    environment_info = Column(JSON)  # Environment details during scan
    
    # Relations
    vulnerabilities = relationship("VulnerabilityFinding", back_populates="scan")

class VulnerabilityFinding(Base):
    """Vulnerability discovered during a security scan"""
    __tablename__ = "vulnerability_findings"

    id = Column(Integer, primary_key=True, index=True)
    scan_id = Column(String, ForeignKey('security_scans.id'))
    scanner = Column(String, nullable=False)  # Scanner that found this
    name = Column(String, nullable=False)
    description = Column(String)
    severity = Column(String, nullable=False)
    confidence = Column(String)

    # Location information
    url = Column(String)
    parameter = Column(String)
    method = Column(String)

    # Technical details
    solution = Column(String)
    references = Column(JSON)  # List of reference URLs
    evidence = Column(String)
    payload = Column(String)
    
    # Classification
    cwe_id = Column(String)
    owasp_category = Column(String)
    tags = Column(JSON)
    
    # Analysis
    attack_complexity = Column(String)
    attack_vector = Column(String)
    privileges_required = Column(String)
    user_interaction = Column(String)
    impact = Column(String)
    risk_score = Column(Float)
    
    # Status tracking
    status = Column(String, default=VulnerabilityStatus.OPEN)
    false_positive = Column(Boolean, default=False)
    discovered_at = Column(DateTime, default=datetime.utcnow)
    first_seen = Column(DateTime)
    last_seen = Column(DateTime)
    fixed_at = Column(DateTime)
    
    # Raw data and relations
    raw_finding = Column(JSON)
    scan = relationship("SecurityScan", back_populates="vulnerabilities")
    mitigations = relationship("VulnerabilityMitigation", back_populates="finding")
    intel_data = relationship("ThreatIntelData", back_populates="finding")
    mitre_techniques = relationship(
        "MITRETechnique",
        secondary="vulnerability_technique_association",
        back_populates="vulnerabilities"
    )

class VulnerabilityMitigation(Base):
    """Mitigation guidance for a vulnerability"""
    __tablename__ = "vulnerability_mitigations"

    id = Column(Integer, primary_key=True, index=True)
    finding_id = Column(Integer, ForeignKey('vulnerability_findings.id'))
    recommendation = Column(String, nullable=False)
    priority = Column(Integer)  # 1-5 scale
    estimated_effort = Column(String)  # Low, Medium, High
    remediation_type = Column(String)  # Code fix, Config change, Patch, etc.
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # AI-generated fields
    code_snippets = Column(JSON)  # Example fix code snippets
    compliance_impact = Column(JSON)  # Affected compliance requirements
    business_impact = Column(String)
    
    # Relations
    finding = relationship("VulnerabilityFinding", back_populates="mitigations")

class ThreatIntelData(Base):
    """Threat intelligence data linked to vulnerabilities"""
    __tablename__ = "threat_intel_data"

    id = Column(Integer, primary_key=True, index=True)
    finding_id = Column(Integer, ForeignKey('vulnerability_findings.id'))
    source = Column(String, nullable=False)  # Intel feed source
    threat_type = Column(String)
    confidence_score = Column(Float)
    last_seen = Column(DateTime)
    exploit_available = Column(Boolean, default=False)
    exploit_details = Column(JSON)
    patch_available = Column(Boolean, default=False)
    patch_info = Column(JSON)
    raw_data = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relations
    finding = relationship("VulnerabilityFinding", back_populates="intel_data")