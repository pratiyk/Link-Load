from sqlalchemy import Column, Integer, String, DateTime, JSON, ForeignKey, Float
from sqlalchemy.orm import relationship
from datetime import datetime
from app.database import Base
from app.models.asset_models import DiscoveredAsset  # Add this import

class VulnerabilityData(Base):
    __tablename__ = "vulnerability_data"

    id = Column(Integer, primary_key=True, index=True)
    source = Column(String, nullable=False)  # Scanner source (Nessus, Qualys, etc.)
    title = Column(String, nullable=False)
    description = Column(String)
    severity = Column(Float, nullable=False)
    cvss_score = Column(Float)
    cvss_vector = Column(String)
    raw_data = Column(JSON)  # Store raw scanner output
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    asset_id = Column(Integer, ForeignKey('discovered_assets.id'))
    
    # Relationships
    asset = relationship("DiscoveredAsset", back_populates="vulnerabilities")
    mitigations = relationship("VulnerabilityMitigation", back_populates="vulnerability")
    intel_data = relationship("ThreatIntelData", back_populates="vulnerability")

class VulnerabilityMitigation(Base):
    __tablename__ = "vulnerability_mitigations"

    id = Column(Integer, primary_key=True, index=True)
    vulnerability_id = Column(Integer, ForeignKey('vulnerability_data.id'))
    recommendation = Column(String, nullable=False)
    priority = Column(Integer)  # 1-5 scale
    estimated_effort = Column(String)  # Low, Medium, High
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    vulnerability = relationship("VulnerabilityData", back_populates="mitigations")

class ThreatIntelData(Base):
    __tablename__ = "threat_intel_data"

    id = Column(Integer, primary_key=True, index=True)
    vulnerability_id = Column(Integer, ForeignKey('vulnerability_data.id'))
    source = Column(String, nullable=False)  # Intel feed source
    threat_type = Column(String)
    confidence_score = Column(Float)
    last_seen = Column(DateTime)
    raw_data = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    vulnerability = relationship("VulnerabilityData", back_populates="intel_data")